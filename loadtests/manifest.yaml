# =============================================================================
# Load Test Manifest - Central Registry for All Load Tests
# =============================================================================
# This manifest is used by the CI/CD pipeline to auto-discover and run tests.
# When you add a new test using the generate-load-test prompt, register it here.
# =============================================================================

version: "1.0"
description: "Contoso University Load Testing Manifest"

# Test profiles define the type of testing scenario
profiles:
  smoke:
    description: "Quick validation tests with minimal load"
    concurrentUsers: 5
    durationSeconds: 60
    rampUpSeconds: 10
    
  load:
    description: "Standard load tests for performance validation"
    concurrentUsers: 50
    durationSeconds: 300
    rampUpSeconds: 60
    
  stress:
    description: "High-load tests to find breaking points"
    concurrentUsers: 200
    durationSeconds: 600
    rampUpSeconds: 120
    
  chaos:
    description: "Tests designed to run during chaos experiments"
    concurrentUsers: 30
    durationSeconds: 900
    rampUpSeconds: 60

# =============================================================================
# Test Definitions - Add new tests here to have them auto-discovered
# =============================================================================
tests:
  # Student Enrollment Load Test (100 users, 5 min)
  - id: student-enrollment
    name: "Student Enrollment Load Test"
    description: "100 concurrent users testing GET /Students and POST /Students/Create for 5 minutes"
    enabled: true
    jmeterFile: scenarios/student-enrollment.jmx
    configFile: scenarios/student-enrollment-config.yaml
    profiles: [load, stress]
    endpoints:
      - /Students
      - /Students/Create
    tags: [enrollment, students, crud, 100-users]
    defaults:
      concurrentUsers: 100
      durationSeconds: 300
      rampUpSeconds: 60

  # Chaos Resilience Test (runs during chaos experiments)
  - id: chaos-resilience
    name: "Chaos Resilience Test"
    description: "Validates application behavior during fault injection"
    enabled: true
    jmeterFile: scenarios/chaos-resilience.jmx
    configFile: scenarios/chaos-config.yaml
    profiles: [chaos]
    endpoints:
      - /health
      - /api/students
    tags: [chaos, resilience, fault-tolerance]

# =============================================================================
# Default failure criteria (can be overridden per test)
# =============================================================================
defaultCriteria:
  avgResponseTimeMs: 2000
  percentile95Ms: 5000
  errorPercentage: 1

# Custom criteria per test ID (optional overrides)
customCriteria:
  chaos-resilience:
    avgResponseTimeMs: 4000  # Higher tolerance during chaos
    percentile95Ms: 8000
    errorPercentage: 5       # Allow some errors during fault injection

# =============================================================================
# Chaos Experiments - Linked to the chaos profile tests
# =============================================================================
chaosExperiments:
  - id: cpu-pressure
    name: "CPU Pressure Test"
    description: "Induces CPU stress on application instances"
    bicep_file: ../infra/chaos/experiments/cpu-pressure.bicep
    linked_test: chaos-resilience
    
  - id: sql-latency
    name: "SQL Latency Injection"
    description: "Injects latency into database operations"
    bicep_file: ../infra/chaos/experiments/sql-latency.bicep
    linked_test: chaos-resilience

# =============================================================================
# Environment-specific URLs (referenced by workflow)
# =============================================================================
environments:
  dev:
    webapp_url_var: DEV_APP_URL
  qa:
    webapp_url_var: QA_APP_URL
  staging:
    webapp_url_var: STAGING_APP_URL
  prod:
    webapp_url_var: PROD_APP_URL
