name: ðŸ—ï¸ Infrastructure Deployment

# =============================================================================
# INFRASTRUCTURE DEPLOYMENT WORKFLOW
# =============================================================================
# This workflow deploys Azure infrastructure and automatically configures
# connection strings for the application.
#
# PREREQUISITES:
# 1. Configure OIDC authentication (recommended) or service principal
# 2. Set required secrets and variables (see below)
# =============================================================================

on:
  push:
    branches: [main]
    paths:
      - 'infra/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force redeploy all infrastructure (ignore resource checks)'
        required: false
        default: false
        type: boolean
      deploy_infrastructure:
        description: 'Deploy/update infrastructure'
        required: false
        default: true
        type: boolean
      configure_app_settings:
        description: 'Configure app connection strings'
        required: false
        default: true
        type: boolean

# Required for OIDC authentication
permissions:
  id-token: write
  contents: read

env:
  # Resource naming
  ENVIRONMENT_NAME: ${{ vars.AZURE_ENVIRONMENT_NAME || secrets.AZURE_ENVIRONMENT_NAME }}
  LOCATION: ${{ vars.AZURE_LOCATION || secrets.AZURE_LOCATION || 'eastus' }}
  RESOURCE_GROUP: rg-${{ vars.AZURE_ENVIRONMENT_NAME || secrets.AZURE_ENVIRONMENT_NAME }}
  
  # App Service names
  WEBAPP_NAME: ${{ vars.AZURE_ENVIRONMENT_NAME || secrets.AZURE_ENVIRONMENT_NAME }}-app
  API_NAME: ${{ vars.AZURE_ENVIRONMENT_NAME || secrets.AZURE_ENVIRONMENT_NAME }}-api
  
  # SQL Configuration
  # SQL_AUTH_MODE: 'sql' for SQL auth (requires passwords), 'aad' for Azure AD only (MCAPS compliant)
  SQL_AUTH_MODE: ${{ vars.SQL_AUTH_MODE || 'aad' }}
  SQL_ADMIN_USERNAME: sqladmin
  SQL_APP_USER: appUser
  SQL_CONNECTION_STRING_KEY: AZURE-SQL-CONNECTION-STRING

jobs:
  # ===========================================================================
  # VALIDATE CONFIGURATION
  # ===========================================================================
  validate:
    name: âœ… Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      resource_group: ${{ steps.config.outputs.resource_group }}
      webapp_name: ${{ steps.config.outputs.webapp_name }}
      api_name: ${{ steps.config.outputs.api_name }}
    
    steps:
      - name: ðŸ” Check Required Secrets
        run: |
          MISSING=""
          AUTH_MODE="${{ env.SQL_AUTH_MODE }}"
          echo "ðŸ” SQL Authentication Mode: $AUTH_MODE"
          
          if [ -z "${{ env.ENVIRONMENT_NAME }}" ]; then
            MISSING="$MISSING AZURE_ENVIRONMENT_NAME"
          fi
          
          # Check auth mode specific secrets
          if [ "$AUTH_MODE" == "sql" ]; then
            echo "ðŸ“‹ Checking SQL Authentication requirements..."
            if [ -z "${{ secrets.AZURE_SQL_ADMIN_PASSWORD }}" ]; then
              MISSING="$MISSING AZURE_SQL_ADMIN_PASSWORD"
            fi
            
            if [ -z "${{ secrets.AZURE_SQL_APP_USER_PASSWORD }}" ]; then
              MISSING="$MISSING AZURE_SQL_APP_USER_PASSWORD"
            fi
          else
            echo "ðŸ“‹ Checking Azure AD Authentication requirements..."
            if [ -z "${{ secrets.AZURE_SQL_AAD_ADMIN_NAME }}" ]; then
              MISSING="$MISSING AZURE_SQL_AAD_ADMIN_NAME"
            fi
            
            if [ -z "${{ secrets.AZURE_SQL_AAD_ADMIN_OBJECT_ID }}" ]; then
              MISSING="$MISSING AZURE_SQL_AAD_ADMIN_OBJECT_ID"
            fi
          fi
          
          if [ -n "$MISSING" ]; then
            echo "âŒ Missing required secrets/variables:$MISSING"
            echo ""
            echo "Please configure the following in your repository settings:"
            echo "  - AZURE_ENVIRONMENT_NAME: Unique prefix for resources"
            echo ""
            if [ "$AUTH_MODE" == "sql" ]; then
              echo "For SQL Authentication mode (SQL_AUTH_MODE=sql):"
              echo "  - AZURE_SQL_ADMIN_PASSWORD: SQL Server admin password"
              echo "  - AZURE_SQL_APP_USER_PASSWORD: SQL app user password"
            else
              echo "For Azure AD Authentication mode (SQL_AUTH_MODE=aad):"
              echo "  - AZURE_SQL_AAD_ADMIN_NAME: Azure AD admin display name"
              echo "  - AZURE_SQL_AAD_ADMIN_OBJECT_ID: Azure AD admin object ID"
            fi
            echo ""
            echo "For OIDC auth, also configure:"
            echo "  - AZURE_CLIENT_ID"
            echo "  - AZURE_TENANT_ID"
            echo "  - AZURE_SUBSCRIPTION_ID"
            exit 1
          fi
          
          echo "âœ… All required configuration found"
      
      - name: ðŸ“ Output Configuration
        id: config
        run: |
          echo "resource_group=${{ env.RESOURCE_GROUP }}" >> $GITHUB_OUTPUT
          echo "webapp_name=${{ env.WEBAPP_NAME }}" >> $GITHUB_OUTPUT
          echo "api_name=${{ env.API_NAME }}" >> $GITHUB_OUTPUT
          
          echo "## ðŸ“‹ Configuration Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ env.RESOURCE_GROUP }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Location | ${{ env.LOCATION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | ${{ env.WEBAPP_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ env.API_NAME }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # DEPLOY INFRASTRUCTURE (if main.bicep exists)
  # ===========================================================================
  deploy-infra:
    name: ðŸ—ï¸ Deploy Infrastructure
    needs: validate
    runs-on: ubuntu-latest
    # Run for push events, or for workflow_dispatch when deploy_infrastructure is not false
    if: github.event_name == 'push' || github.event.inputs.deploy_infrastructure != 'false'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        continue-on-error: true
        id: oidc-login

      - name: ðŸ” Azure Login (Service Principal Fallback)
        if: steps.oidc-login.outcome == 'failure'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ“ Check for Infrastructure Templates
        id: check-infra
        run: |
          if [ -f "infra/main.bicep" ]; then
            echo "has_main_bicep=true" >> $GITHUB_OUTPUT
            echo "âœ… Found infra/main.bicep"
          else
            echo "has_main_bicep=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No infra/main.bicep found - skipping infrastructure deployment"
            echo "Infrastructure deployment skipped - no main.bicep found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ” Check Resource Group Exists
        if: steps.check-infra.outputs.has_main_bicep == 'true'
        id: check-rg
        run: |
          if az group show --name "${{ env.RESOURCE_GROUP }}" &>/dev/null; then
            echo "rg_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Resource group ${{ env.RESOURCE_GROUP }} exists"
          else
            echo "rg_exists=false" >> $GITHUB_OUTPUT
            echo "needs_deploy=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Resource group ${{ env.RESOURCE_GROUP }} will be created"
            echo "ðŸš€ Deployment required - resource group doesn't exist"
          fi

      - name: ðŸ” Check Missing Resources
        if: steps.check-infra.outputs.has_main_bicep == 'true' && steps.check-rg.outputs.rg_exists == 'true'
        id: check-resources
        run: |
          RG="${{ env.RESOURCE_GROUP }}"
          MISSING=""
          
          # Check SQL Server
          if ! az sql server show -g "$RG" -n "sql-${{ env.ENVIRONMENT_NAME }}" &>/dev/null; then
            MISSING="$MISSING SQL-Server"
            echo "âš ï¸ SQL Server not found"
          else
            echo "âœ… SQL Server exists"
          fi
          
          # Check SQL Database
          if ! az sql db show -g "$RG" -s "sql-${{ env.ENVIRONMENT_NAME }}" -n "sqldb-${{ env.ENVIRONMENT_NAME }}" &>/dev/null 2>&1; then
            MISSING="$MISSING SQL-Database"
            echo "âš ï¸ SQL Database not found"
          else
            echo "âœ… SQL Database exists"
          fi
          
          # Check App Service Plan
          if ! az appservice plan show -g "$RG" -n "plan-${{ env.ENVIRONMENT_NAME }}" &>/dev/null; then
            MISSING="$MISSING AppServicePlan"
            echo "âš ï¸ App Service Plan not found"
          else
            echo "âœ… App Service Plan exists"
          fi
          
          # Check Web App
          if ! az webapp show -g "$RG" -n "${{ env.WEBAPP_NAME }}" &>/dev/null; then
            MISSING="$MISSING WebApp"
            echo "âš ï¸ Web App not found"
          else
            echo "âœ… Web App exists"
          fi
          
          # Check API App
          if ! az webapp show -g "$RG" -n "${{ env.API_NAME }}" &>/dev/null; then
            MISSING="$MISSING APIApp"
            echo "âš ï¸ API App not found"
          else
            echo "âœ… API App exists"
          fi
          
          # Check Application Insights
          if ! az monitor app-insights component show -g "$RG" -a "appi-${{ env.ENVIRONMENT_NAME }}" &>/dev/null; then
            MISSING="$MISSING AppInsights"
            echo "âš ï¸ Application Insights not found"
          else
            echo "âœ… Application Insights exists"
          fi
          
          # Check Load Testing
          if ! az load show -g "$RG" -n "lt-${{ env.ENVIRONMENT_NAME }}" &>/dev/null 2>&1; then
            MISSING="$MISSING LoadTesting"
            echo "âš ï¸ Load Testing not found"
          else
            echo "âœ… Load Testing exists"
          fi
          
          if [ -n "$MISSING" ]; then
            echo "needs_deploy=true" >> $GITHUB_OUTPUT
            echo "missing_resources=$MISSING" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸ“‹ Missing resources:$MISSING"
            echo "ðŸš€ Deployment required!"
          else
            echo "needs_deploy=false" >> $GITHUB_OUTPUT
            echo "âœ… All resources exist - deployment will be skipped"
            echo "ðŸ’¡ Use force_deploy=true to redeploy anyway"
          fi

      - name: â­ï¸ Skip Deploy (All Resources Exist)
        if: |
          steps.check-infra.outputs.has_main_bicep == 'true' &&
          steps.check-rg.outputs.needs_deploy != 'true' &&
          steps.check-resources.outputs.needs_deploy != 'true' &&
          github.event.inputs.force_deploy != 'true'
        run: |
          echo "## â­ï¸ Infrastructure Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All resources already exist. Use **force_deploy=true** to redeploy." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Existing Resources:" >> $GITHUB_STEP_SUMMARY
          echo "- Resource Group: ${{ env.RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "- SQL Server: sql-${{ env.ENVIRONMENT_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- Web App: ${{ env.WEBAPP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- API App: ${{ env.API_NAME }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ—ï¸ Deploy Bicep Template (SQL Auth)
        if: |
          env.SQL_AUTH_MODE == 'sql' &&
          steps.check-infra.outputs.has_main_bicep == 'true' && 
          (github.event.inputs.force_deploy == 'true' || 
           steps.check-rg.outputs.needs_deploy == 'true' || 
           steps.check-resources.outputs.needs_deploy == 'true')
        id: deploy-sql
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.LOCATION }}
          template: infra/main.bicep
          deploymentName: 'infra-${{ github.run_id }}'
          parameters: >
            environmentName=${{ env.ENVIRONMENT_NAME }}
            location=${{ env.LOCATION }}
            webServiceName=${{ env.WEBAPP_NAME }}
            apiServiceName=${{ env.API_NAME }}
            sqlAuthMode=sql
            sqlAdminUsername=${{ env.SQL_ADMIN_USERNAME }}
            sqlAdminPassword=${{ secrets.AZURE_SQL_ADMIN_PASSWORD }}
            sqlAppUserPassword=${{ secrets.AZURE_SQL_APP_USER_PASSWORD }}
            sqlAppUser=${{ env.SQL_APP_USER }}
            sqlConnectionStringKey=${{ env.SQL_CONNECTION_STRING_KEY }}
          failOnStdErr: false

      - name: ðŸ—ï¸ Deploy Bicep Template (Azure AD Auth)
        if: |
          env.SQL_AUTH_MODE != 'sql' &&
          steps.check-infra.outputs.has_main_bicep == 'true' && 
          (github.event.inputs.force_deploy == 'true' || 
           steps.check-rg.outputs.needs_deploy == 'true' || 
           steps.check-resources.outputs.needs_deploy == 'true')
        id: deploy-aad
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.LOCATION }}
          template: infra/main.bicep
          deploymentName: 'infra-${{ github.run_id }}'
          parameters: >
            environmentName=${{ env.ENVIRONMENT_NAME }}
            location=${{ env.LOCATION }}
            webServiceName=${{ env.WEBAPP_NAME }}
            apiServiceName=${{ env.API_NAME }}
            sqlAuthMode=aad
            sqlAadAdminName=${{ secrets.AZURE_SQL_AAD_ADMIN_NAME }}
            sqlAadAdminObjectId=${{ secrets.AZURE_SQL_AAD_ADMIN_OBJECT_ID }}
            sqlConnectionStringKey=${{ env.SQL_CONNECTION_STRING_KEY }}
          failOnStdErr: false

      - name: ï¿½ Export Resource Names to GitHub Variables
        if: steps.deploy-sql.outcome == 'success' || steps.deploy-aad.outcome == 'success' || steps.check-resources.outputs.needs_deploy != 'true'
        env:
          # Use GH_PAT if available (required for setting repo variables), fallback to GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¤ Exporting resource names to GitHub Variables..."
          echo ""
          echo "â„¹ï¸ Note: Setting GitHub Variables requires a Personal Access Token (PAT) with 'repo' scope."
          echo "   Store it as a secret named 'GH_PAT'. Without it, variables won't be set automatically."
          echo ""
          gh variable set AZURE_RESOURCE_GROUP --body "${{ env.RESOURCE_GROUP }}" || echo "âš ï¸ Could not set AZURE_RESOURCE_GROUP"
          gh variable set AZURE_WEBAPP_NAME --body "${{ env.WEBAPP_NAME }}" || echo "âš ï¸ Could not set AZURE_WEBAPP_NAME"  
          gh variable set AZURE_API_NAME --body "${{ env.API_NAME }}" || echo "âš ï¸ Could not set AZURE_API_NAME"
          gh variable set AZURE_SQL_SERVER --body "sql-${{ env.ENVIRONMENT_NAME }}" || echo "âš ï¸ Could not set AZURE_SQL_SERVER"
          gh variable set AZURE_SQL_DATABASE --body "sqldb-${{ env.ENVIRONMENT_NAME }}" || echo "âš ï¸ Could not set AZURE_SQL_DATABASE"
          gh variable set AZURE_KEY_VAULT_NAME --body "kv-${{ env.ENVIRONMENT_NAME }}" || echo "âš ï¸ Could not set AZURE_KEY_VAULT_NAME"
          gh variable set AZURE_KEY_VAULT_ENDPOINT --body "https://kv-${{ env.ENVIRONMENT_NAME }}.vault.azure.net/" || echo "âš ï¸ Could not set AZURE_KEY_VAULT_ENDPOINT"
          gh variable set AZURE_APPINSIGHTS_NAME --body "appi-${{ env.ENVIRONMENT_NAME }}" || echo "âš ï¸ Could not set AZURE_APPINSIGHTS_NAME"
          gh variable set AZURE_LOAD_TEST_RESOURCE --body "lt-${{ env.ENVIRONMENT_NAME }}" || echo "âš ï¸ Could not set AZURE_LOAD_TEST_RESOURCE"
          gh variable set AZURE_APP_SERVICE_PLAN --body "plan-${{ env.ENVIRONMENT_NAME }}" || echo "âš ï¸ Could not set AZURE_APP_SERVICE_PLAN"
          gh variable set SQL_AUTH_MODE --body "${{ env.SQL_AUTH_MODE }}" || echo "âš ï¸ Could not set SQL_AUTH_MODE"
          
          # Web App URL
          gh variable set AZURE_WEBAPP_URL --body "https://${{ env.WEBAPP_NAME }}.azurewebsites.net" || echo "âš ï¸ Could not set AZURE_WEBAPP_URL"
          gh variable set AZURE_API_URL --body "https://${{ env.API_NAME }}.azurewebsites.net" || echo "âš ï¸ Could not set AZURE_API_URL"
          
          echo "âœ… Resource variables exported for other workflows"

      - name: ðŸ“‹ Deployment Summary
        if: steps.deploy-sql.outcome == 'success' || steps.deploy-aad.outcome == 'success'
        run: |
          echo "## ðŸ—ï¸ Infrastructure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources:" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Name |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ env.RESOURCE_GROUP }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | ${{ env.WEBAPP_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API App | ${{ env.API_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SQL Server | sql-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SQL Database | sqldb-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Application Insights | appi-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Load Testing | lt-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- Web App: https://${{ env.WEBAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://${{ env.API_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¤ Exported Variables:" >> $GITHUB_STEP_SUMMARY
          echo "The following GitHub Variables are now available for other workflows:" >> $GITHUB_STEP_SUMMARY
          echo "- \`AZURE_RESOURCE_GROUP\`, \`AZURE_WEBAPP_NAME\`, \`AZURE_API_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`AZURE_LOAD_TEST_RESOURCE\`, \`AZURE_APPINSIGHTS_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`AZURE_WEBAPP_URL\`, \`AZURE_API_URL\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # VERIFY DEPLOYMENT (Configuration is done via Bicep + Key Vault)
  # ===========================================================================
  verify-deployment:
    name: âœ… Verify Deployment
    needs: [validate, deploy-infra]
    if: always() && needs.validate.result == 'success' && needs.deploy-infra.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ” Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        continue-on-error: true
        id: oidc-login

      - name: ðŸ” Azure Login (Service Principal Fallback)
        if: steps.oidc-login.outcome == 'failure'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ” Verify Resources
        run: |
          echo "ðŸ” Verifying deployed resources..."
          
          # Verify Key Vault
          KV_NAME="kv-${{ env.ENVIRONMENT_NAME }}"
          if az keyvault show -n "$KV_NAME" &>/dev/null; then
            echo "âœ… Key Vault: $KV_NAME"
          else
            echo "âš ï¸ Key Vault not found: $KV_NAME"
          fi
          
          # Verify SQL Server
          SQL_NAME="sql-${{ env.ENVIRONMENT_NAME }}"
          if az sql server show -g "${{ env.RESOURCE_GROUP }}" -n "$SQL_NAME" &>/dev/null; then
            echo "âœ… SQL Server: $SQL_NAME"
          else
            echo "âš ï¸ SQL Server not found: $SQL_NAME"
          fi
          
          # Verify Web App
          if az webapp show -g "${{ env.RESOURCE_GROUP }}" -n "${{ env.WEBAPP_NAME }}" &>/dev/null; then
            echo "âœ… Web App: ${{ env.WEBAPP_NAME }}"
            
            # Check app settings
            KV_ENDPOINT=$(az webapp config appsettings list -g "${{ env.RESOURCE_GROUP }}" -n "${{ env.WEBAPP_NAME }}" --query "[?name=='Api__Address'].value" -o tsv)
            if [ -n "$KV_ENDPOINT" ]; then
              echo "  âœ… API Address configured: $KV_ENDPOINT"
            fi
          else
            echo "âš ï¸ Web App not found: ${{ env.WEBAPP_NAME }}"
          fi
          
          # Verify API App
          if az webapp show -g "${{ env.RESOURCE_GROUP }}" -n "${{ env.API_NAME }}" &>/dev/null; then
            echo "âœ… API App: ${{ env.API_NAME }}"
            
            # Check Key Vault integration
            KV_ENDPOINT=$(az webapp config appsettings list -g "${{ env.RESOURCE_GROUP }}" -n "${{ env.API_NAME }}" --query "[?name=='AZURE_KEY_VAULT_ENDPOINT'].value" -o tsv)
            if [ -n "$KV_ENDPOINT" ]; then
              echo "  âœ… Key Vault endpoint configured: $KV_ENDPOINT"
            fi
            
            CONN_KEY=$(az webapp config appsettings list -g "${{ env.RESOURCE_GROUP }}" -n "${{ env.API_NAME }}" --query "[?name=='AZURE_SQL_CONNECTION_STRING_KEY'].value" -o tsv)
            if [ -n "$CONN_KEY" ]; then
              echo "  âœ… SQL connection string key configured: $CONN_KEY"
            fi
          else
            echo "âš ï¸ API App not found: ${{ env.API_NAME }}"
          fi

      - name: ðŸ“‹ Deployment Summary
        run: |
          echo "## âœ… Infrastructure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—ï¸ Resources Created:" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Name |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ env.RESOURCE_GROUP }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault | kv-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SQL Server | sql-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SQL Database | sqldb-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | ${{ env.WEBAPP_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API App | ${{ env.API_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| App Insights | appi-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Load Testing | lt-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SQL connection string stored in Key Vault" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… App user created via deployment script" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… API App configured with Key Vault integration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Web App configured with API endpoint" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- Web App: https://${{ env.WEBAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://${{ env.API_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- Key Vault: https://kv-${{ env.ENVIRONMENT_NAME }}.vault.azure.net/" >> $GITHUB_STEP_SUMMARY
