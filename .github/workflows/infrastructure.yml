name: ðŸ—ï¸ Infrastructure Deployment

# =============================================================================
# INFRASTRUCTURE DEPLOYMENT WORKFLOW
# =============================================================================
# This workflow deploys Azure infrastructure and automatically configures
# connection strings for the application.
#
# PREREQUISITES:
# 1. Configure OIDC authentication (recommended) or service principal
# 2. Set required secrets and variables (see below)
# =============================================================================

on:
  push:
    branches: [main]
    paths:
      - 'infra/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force redeploy all infrastructure (ignore resource checks)'
        required: false
        default: false
        type: boolean
      deploy_infrastructure:
        description: 'Deploy/update infrastructure'
        required: false
        default: true
        type: boolean
      configure_app_settings:
        description: 'Configure app connection strings'
        required: false
        default: true
        type: boolean

# Required for OIDC authentication
permissions:
  id-token: write
  contents: read

env:
  # Resource naming
  ENVIRONMENT_NAME: ${{ vars.AZURE_ENVIRONMENT_NAME || secrets.AZURE_ENVIRONMENT_NAME }}
  LOCATION: ${{ vars.AZURE_LOCATION || secrets.AZURE_LOCATION || 'eastus' }}
  RESOURCE_GROUP: rg-${{ vars.AZURE_ENVIRONMENT_NAME || secrets.AZURE_ENVIRONMENT_NAME }}
  
  # App Service names
  WEBAPP_NAME: ${{ vars.AZURE_ENVIRONMENT_NAME || secrets.AZURE_ENVIRONMENT_NAME }}-app
  API_NAME: ${{ vars.AZURE_ENVIRONMENT_NAME || secrets.AZURE_ENVIRONMENT_NAME }}-api
  
  # SQL credentials
  SQL_ADMIN_PASSWORD: ${{ secrets.AZURE_SQL_PASSWORD }}
  SQL_APP_PASSWORD: ${{ secrets.AZURE_APP_PASSWORD }}

jobs:
  # ===========================================================================
  # VALIDATE CONFIGURATION
  # ===========================================================================
  validate:
    name: âœ… Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      resource_group: ${{ steps.config.outputs.resource_group }}
      webapp_name: ${{ steps.config.outputs.webapp_name }}
      api_name: ${{ steps.config.outputs.api_name }}
    
    steps:
      - name: ðŸ” Check Required Secrets
        run: |
          MISSING=""
          
          if [ -z "${{ env.ENVIRONMENT_NAME }}" ]; then
            MISSING="$MISSING AZURE_ENVIRONMENT_NAME"
          fi
          
          if [ -z "${{ env.SQL_ADMIN_PASSWORD }}" ]; then
            MISSING="$MISSING AZURE_SQL_PASSWORD"
          fi
          
          if [ -n "$MISSING" ]; then
            echo "âŒ Missing required secrets/variables:$MISSING"
            echo ""
            echo "Please configure the following in your repository settings:"
            echo "  - AZURE_ENVIRONMENT_NAME: Unique prefix for resources"
            echo "  - AZURE_SQL_PASSWORD: SQL Server admin password"
            echo "  - AZURE_APP_PASSWORD: SQL app user password (optional)"
            echo ""
            echo "For OIDC auth, also configure:"
            echo "  - AZURE_CLIENT_ID"
            echo "  - AZURE_TENANT_ID"
            echo "  - AZURE_SUBSCRIPTION_ID"
            exit 1
          fi
          
          echo "âœ… All required configuration found"
      
      - name: ðŸ“ Output Configuration
        id: config
        run: |
          echo "resource_group=${{ env.RESOURCE_GROUP }}" >> $GITHUB_OUTPUT
          echo "webapp_name=${{ env.WEBAPP_NAME }}" >> $GITHUB_OUTPUT
          echo "api_name=${{ env.API_NAME }}" >> $GITHUB_OUTPUT
          
          echo "## ðŸ“‹ Configuration Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ env.RESOURCE_GROUP }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Location | ${{ env.LOCATION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | ${{ env.WEBAPP_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ env.API_NAME }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # DEPLOY INFRASTRUCTURE (if main.bicep exists)
  # ===========================================================================
  deploy-infra:
    name: ðŸ—ï¸ Deploy Infrastructure
    needs: validate
    runs-on: ubuntu-latest
    # Run for push events, or for workflow_dispatch when deploy_infrastructure is not false
    if: github.event_name == 'push' || github.event.inputs.deploy_infrastructure != 'false'
    outputs:
      sql_server_name: ${{ steps.deploy.outputs.sqlServerName }}
      sql_db_name: ${{ steps.deploy.outputs.sqlDatabaseName }}
      appinsights_name: ${{ steps.deploy.outputs.appInsightsName }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        continue-on-error: true
        id: oidc-login

      - name: ðŸ” Azure Login (Service Principal Fallback)
        if: steps.oidc-login.outcome == 'failure'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ“ Check for Infrastructure Templates
        id: check-infra
        run: |
          if [ -f "infra/main.bicep" ]; then
            echo "has_main_bicep=true" >> $GITHUB_OUTPUT
            echo "âœ… Found infra/main.bicep"
          else
            echo "has_main_bicep=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No infra/main.bicep found - skipping infrastructure deployment"
            echo "Infrastructure deployment skipped - no main.bicep found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ” Check Resource Group Exists
        if: steps.check-infra.outputs.has_main_bicep == 'true'
        id: check-rg
        run: |
          if az group show --name "${{ env.RESOURCE_GROUP }}" &>/dev/null; then
            echo "rg_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Resource group ${{ env.RESOURCE_GROUP }} exists"
          else
            echo "rg_exists=false" >> $GITHUB_OUTPUT
            echo "needs_deploy=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Resource group ${{ env.RESOURCE_GROUP }} will be created"
            echo "ðŸš€ Deployment required - resource group doesn't exist"
          fi

      - name: ðŸ” Check Missing Resources
        if: steps.check-infra.outputs.has_main_bicep == 'true' && steps.check-rg.outputs.rg_exists == 'true'
        id: check-resources
        run: |
          RG="${{ env.RESOURCE_GROUP }}"
          MISSING=""
          
          # Check SQL Server
          if ! az sql server show -g "$RG" -n "sql-${{ env.ENVIRONMENT_NAME }}" &>/dev/null; then
            MISSING="$MISSING SQL-Server"
            echo "âš ï¸ SQL Server not found"
          else
            echo "âœ… SQL Server exists"
          fi
          
          # Check SQL Database
          if ! az sql db show -g "$RG" -s "sql-${{ env.ENVIRONMENT_NAME }}" -n "sqldb-${{ env.ENVIRONMENT_NAME }}" &>/dev/null 2>&1; then
            MISSING="$MISSING SQL-Database"
            echo "âš ï¸ SQL Database not found"
          else
            echo "âœ… SQL Database exists"
          fi
          
          # Check App Service Plan
          if ! az appservice plan show -g "$RG" -n "plan-${{ env.ENVIRONMENT_NAME }}" &>/dev/null; then
            MISSING="$MISSING AppServicePlan"
            echo "âš ï¸ App Service Plan not found"
          else
            echo "âœ… App Service Plan exists"
          fi
          
          # Check Web App
          if ! az webapp show -g "$RG" -n "${{ env.WEBAPP_NAME }}" &>/dev/null; then
            MISSING="$MISSING WebApp"
            echo "âš ï¸ Web App not found"
          else
            echo "âœ… Web App exists"
          fi
          
          # Check API App
          if ! az webapp show -g "$RG" -n "${{ env.API_NAME }}" &>/dev/null; then
            MISSING="$MISSING APIApp"
            echo "âš ï¸ API App not found"
          else
            echo "âœ… API App exists"
          fi
          
          # Check Application Insights
          if ! az monitor app-insights component show -g "$RG" -a "appi-${{ env.ENVIRONMENT_NAME }}" &>/dev/null; then
            MISSING="$MISSING AppInsights"
            echo "âš ï¸ Application Insights not found"
          else
            echo "âœ… Application Insights exists"
          fi
          
          # Check Load Testing
          if ! az load show -g "$RG" -n "lt-${{ env.ENVIRONMENT_NAME }}" &>/dev/null 2>&1; then
            MISSING="$MISSING LoadTesting"
            echo "âš ï¸ Load Testing not found"
          else
            echo "âœ… Load Testing exists"
          fi
          
          if [ -n "$MISSING" ]; then
            echo "needs_deploy=true" >> $GITHUB_OUTPUT
            echo "missing_resources=$MISSING" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸ“‹ Missing resources:$MISSING"
            echo "ðŸš€ Deployment required!"
          else
            echo "needs_deploy=false" >> $GITHUB_OUTPUT
            echo "âœ… All resources exist - deployment will be skipped"
            echo "ðŸ’¡ Use force_deploy=true to redeploy anyway"
          fi

      - name: â­ï¸ Skip Deploy (All Resources Exist)
        if: |
          steps.check-infra.outputs.has_main_bicep == 'true' &&
          steps.check-rg.outputs.needs_deploy != 'true' &&
          steps.check-resources.outputs.needs_deploy != 'true' &&
          github.event.inputs.force_deploy != 'true'
        run: |
          echo "## â­ï¸ Infrastructure Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All resources already exist. Use **force_deploy=true** to redeploy." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Existing Resources:" >> $GITHUB_STEP_SUMMARY
          echo "- Resource Group: ${{ env.RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "- SQL Server: sql-${{ env.ENVIRONMENT_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- Web App: ${{ env.WEBAPP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- API App: ${{ env.API_NAME }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ—ï¸ Deploy Bicep Template
        if: |
          steps.check-infra.outputs.has_main_bicep == 'true' && 
          (github.event.inputs.force_deploy == 'true' || 
           steps.check-rg.outputs.needs_deploy == 'true' || 
           steps.check-resources.outputs.needs_deploy == 'true')
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.LOCATION }}
          template: infra/main.bicep
          deploymentMode: Incremental
          deploymentName: 'infra-${{ github.run_id }}'
          parameters: >
            environmentName=${{ env.ENVIRONMENT_NAME }}
            location=${{ env.LOCATION }}
            webServiceName=${{ env.WEBAPP_NAME }}
            apiServiceName=${{ env.API_NAME }}
            sqlAdminPassword=${{ env.SQL_ADMIN_PASSWORD }}
            appUserPassword=${{ env.SQL_APP_PASSWORD }}
          failOnStdErr: false

      - name: ðŸ“‹ Deployment Summary
        if: steps.deploy.outcome == 'success'
        run: |
          echo "## ðŸ—ï¸ Infrastructure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources:" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Name |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ env.RESOURCE_GROUP }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | ${{ env.WEBAPP_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API App | ${{ env.API_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SQL Server | sql-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SQL Database | sqldb-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Application Insights | appi-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Load Testing | lt-${{ env.ENVIRONMENT_NAME }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # CONFIGURE APP SETTINGS & CONNECTION STRINGS
  # ===========================================================================
  configure-app:
    name: âš™ï¸ Configure App Settings
    needs: [validate, deploy-infra]
    # Run for push events, or for workflow_dispatch when configure_app_settings is not false
    if: always() && needs.validate.result == 'success' && (github.event_name == 'push' || github.event.inputs.configure_app_settings != 'false')
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ” Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        continue-on-error: true
        id: oidc-login

      - name: ðŸ” Azure Login (Service Principal Fallback)
        if: steps.oidc-login.outcome == 'failure'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ” Discover Azure Resources
        id: discover
        run: |
          echo "ðŸ” Discovering resources in ${{ env.RESOURCE_GROUP }}..."
          
          # Check if resource group exists
          if ! az group show --name "${{ env.RESOURCE_GROUP }}" &>/dev/null; then
            echo "âŒ Resource group ${{ env.RESOURCE_GROUP }} not found"
            echo "Please deploy infrastructure first or check AZURE_ENVIRONMENT_NAME"
            exit 1
          fi
          
          # Find SQL Server
          SQL_SERVER=$(az sql server list -g "${{ env.RESOURCE_GROUP }}" --query "[0].name" -o tsv 2>/dev/null || echo "")
          if [ -n "$SQL_SERVER" ]; then
            echo "sql_server=$SQL_SERVER" >> $GITHUB_OUTPUT
            echo "âœ… Found SQL Server: $SQL_SERVER"
            
            # Find SQL Database
            SQL_DB=$(az sql db list -g "${{ env.RESOURCE_GROUP }}" -s "$SQL_SERVER" --query "[?name!='master'].name | [0]" -o tsv 2>/dev/null || echo "")
            echo "sql_database=$SQL_DB" >> $GITHUB_OUTPUT
            echo "âœ… Found SQL Database: $SQL_DB"
            
            # Get SQL Server FQDN
            SQL_FQDN=$(az sql server show -g "${{ env.RESOURCE_GROUP }}" -n "$SQL_SERVER" --query "fullyQualifiedDomainName" -o tsv)
            echo "sql_fqdn=$SQL_FQDN" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No SQL Server found in resource group"
          fi
          
          # Find Application Insights
          APP_INSIGHTS=$(az monitor app-insights component list -g "${{ env.RESOURCE_GROUP }}" --query "[0].name" -o tsv 2>/dev/null || echo "")
          if [ -n "$APP_INSIGHTS" ]; then
            echo "app_insights=$APP_INSIGHTS" >> $GITHUB_OUTPUT
            echo "âœ… Found Application Insights: $APP_INSIGHTS"
            
            # Get connection string
            AI_CONN=$(az monitor app-insights component show -g "${{ env.RESOURCE_GROUP }}" -a "$APP_INSIGHTS" --query "connectionString" -o tsv)
            echo "app_insights_conn=$AI_CONN" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No Application Insights found in resource group"
          fi
          
          # Find Web App
          WEBAPP=$(az webapp list -g "${{ env.RESOURCE_GROUP }}" --query "[?contains(name, 'app')].name | [0]" -o tsv 2>/dev/null || echo "${{ env.WEBAPP_NAME }}")
          echo "webapp_name=$WEBAPP" >> $GITHUB_OUTPUT
          echo "âœ… Web App: $WEBAPP"
          
          # Find API App
          API=$(az webapp list -g "${{ env.RESOURCE_GROUP }}" --query "[?contains(name, 'api')].name | [0]" -o tsv 2>/dev/null || echo "${{ env.API_NAME }}")
          echo "api_name=$API" >> $GITHUB_OUTPUT
          echo "âœ… API App: $API"

      - name: ðŸ”— Build Connection Strings
        id: connstrings
        run: |
          SQL_SERVER="${{ steps.discover.outputs.sql_fqdn }}"
          SQL_DB="${{ steps.discover.outputs.sql_database }}"
          
          if [ -n "$SQL_SERVER" ] && [ -n "$SQL_DB" ]; then
            # Build SQL connection string (using app user if available, otherwise admin)
            if [ -n "${{ env.SQL_APP_PASSWORD }}" ]; then
              SQL_USER="appUser"
              SQL_PASS="${{ env.SQL_APP_PASSWORD }}"
            else
              SQL_USER="sqladmin"
              SQL_PASS="${{ env.SQL_ADMIN_PASSWORD }}"
            fi
            
            SQL_CONN="Server=tcp:${SQL_SERVER},1433;Initial Catalog=${SQL_DB};Persist Security Info=False;User ID=${SQL_USER};Password=${SQL_PASS};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
            
            # Mask the connection string in logs
            echo "::add-mask::$SQL_CONN"
            echo "sql_connection=$SQL_CONN" >> $GITHUB_OUTPUT
            echo "âœ… SQL connection string built"
          else
            echo "âš ï¸ Cannot build SQL connection string - missing server or database info"
          fi

      - name: âš™ï¸ Configure Web App Settings
        if: steps.discover.outputs.webapp_name != ''
        run: |
          WEBAPP="${{ steps.discover.outputs.webapp_name }}"
          
          echo "âš™ï¸ Configuring $WEBAPP..."
          
          # Set connection string if available
          if [ -n "${{ steps.connstrings.outputs.sql_connection }}" ]; then
            echo "Setting SQL connection string..."
            az webapp config connection-string set \
              -g "${{ env.RESOURCE_GROUP }}" \
              -n "$WEBAPP" \
              --connection-string-type SQLAzure \
              --settings "ContosoUniversityAPIContext=${{ steps.connstrings.outputs.sql_connection }}" \
              --output none
            echo "âœ… SQL connection string configured"
          fi
          
          # Set Application Insights if available
          if [ -n "${{ steps.discover.outputs.app_insights_conn }}" ]; then
            echo "Setting Application Insights..."
            az webapp config appsettings set \
              -g "${{ env.RESOURCE_GROUP }}" \
              -n "$WEBAPP" \
              --settings "APPLICATIONINSIGHTS_CONNECTION_STRING=${{ steps.discover.outputs.app_insights_conn }}" \
              --output none
            echo "âœ… Application Insights configured"
          fi
          
          echo "âœ… Web App configuration complete"

      - name: âš™ï¸ Configure API App Settings
        if: steps.discover.outputs.api_name != ''
        run: |
          API="${{ steps.discover.outputs.api_name }}"
          
          echo "âš™ï¸ Configuring $API..."
          
          # Set connection string if available
          if [ -n "${{ steps.connstrings.outputs.sql_connection }}" ]; then
            echo "Setting SQL connection string..."
            az webapp config connection-string set \
              -g "${{ env.RESOURCE_GROUP }}" \
              -n "$API" \
              --connection-string-type SQLAzure \
              --settings "ContosoUniversityAPIContext=${{ steps.connstrings.outputs.sql_connection }}" \
              --output none
            echo "âœ… SQL connection string configured"
          fi
          
          # Set Application Insights if available
          if [ -n "${{ steps.discover.outputs.app_insights_conn }}" ]; then
            echo "Setting Application Insights..."
            az webapp config appsettings set \
              -g "${{ env.RESOURCE_GROUP }}" \
              -n "$API" \
              --settings "APPLICATIONINSIGHTS_CONNECTION_STRING=${{ steps.discover.outputs.app_insights_conn }}" \
              --output none
            echo "âœ… Application Insights configured"
          fi
          
          echo "âœ… API App configuration complete"

      - name: ðŸ“‹ Configuration Summary
        run: |
          echo "## âœ… App Configuration Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources Configured:" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.discover.outputs.webapp_name }}" ]; then
            echo "| Web App (${{ steps.discover.outputs.webapp_name }}) | âœ… Configured |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ steps.discover.outputs.api_name }}" ]; then
            echo "| API (${{ steps.discover.outputs.api_name }}) | âœ… Configured |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Connection Strings:" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.connstrings.outputs.sql_connection }}" ]; then
            echo "- âœ… SQL Database connection string set" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ SQL Database connection string not configured" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ steps.discover.outputs.app_insights_conn }}" ]; then
            echo "- âœ… Application Insights connection string set" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Application Insights not configured" >> $GITHUB_STEP_SUMMARY
          fi
