name: ðŸš€ Build, Test & Deploy with Resilience Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_load_test:
        description: 'Run Azure Load Testing'
        required: false
        default: 'true'
        type: boolean
      run_chaos_test:
        description: 'Run Chaos Studio Experiments'
        required: false
        default: 'false'
        type: boolean

env:
  AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME }}
  DOTNET_VERSION: '6.0.x'

jobs:
  build:
    name: ðŸ”¨ Build & Unit Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¦ Restore dependencies
        run: dotnet restore src/ContosoUniversity.WebApplication/ContosoUniversity.WebApplication.csproj

      - name: ðŸ—ï¸ Build application
        run: dotnet build src/ContosoUniversity.WebApplication/ContosoUniversity.WebApplication.csproj --configuration Release --no-restore

      - name: ðŸ§ª Run unit tests
        run: dotnet test src/ContosoUniversity.Test/ContosoUniversity.Test.csproj --configuration Release --verbosity normal --collect:"XPlat Code Coverage"

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webapp-build
          path: src/ContosoUniversity.WebApplication/bin/Release/net6.0/

  deploy-staging:
    name: ðŸŒ Deploy to Staging
    needs: build
    runs-on: ubuntu-latest
    environment: 
      name: staging
      url: ${{ steps.deploy.outputs.webapp-url }}
    
    outputs:
      webapp-url: ${{ steps.deploy.outputs.webapp-url }}

    steps:
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: webapp-build
          path: ./publish

      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸš€ Deploy to Azure Web App (Staging)
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: staging
          package: ./publish

      - name: ðŸ¥ Health Check
        run: |
          echo "Waiting for application to warm up..."
          sleep 30
          
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.deploy.outputs.webapp-url }}/health" || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed with status: $response"
            exit 1
          fi

  load-test:
    name: ðŸ“Š Azure Load Testing
    needs: deploy-staging
    if: github.event.inputs.run_load_test == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ“Š Run Azure Load Test
        uses: azure/load-testing@v1
        with:
          loadTestConfigFile: 'loadtests/config.yaml'
          loadTestResource: ${{ secrets.AZURE_LOAD_TEST_RESOURCE }}
          resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
          env: |
            [
              { "name": "webapp_url", "value": "${{ needs.deploy-staging.outputs.webapp-url }}" },
              { "name": "concurrent_users", "value": "100" },
              { "name": "duration_seconds", "value": "300" }
            ]

      - name: ðŸ“ˆ Upload Load Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-results
          path: ${{ github.workspace }}/loadTest

  chaos-test:
    name: ðŸ”¥ Chaos Engineering
    needs: [deploy-staging, load-test]
    if: github.event.inputs.run_chaos_test == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸŽ¯ Start Chaos Experiment - SQL Latency
        run: |
          echo "ðŸ”¥ Starting chaos experiment: SQL Latency Injection"
          
          az chaos experiment start \
            --name "sql-latency-experiment" \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          
          echo "â³ Waiting for experiment to complete..."
          sleep 180  # 3 minutes experiment duration
          
          # Check experiment status
          status=$(az chaos experiment show \
            --name "sql-latency-experiment" \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query "properties.provisioningState" -o tsv)
          
          echo "ðŸ“Š Experiment status: $status"

      - name: ðŸ“Š Validate System Resilience
        run: |
          echo "ðŸ” Checking application health during chaos..."
          
          # Run quick load test during chaos
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ needs.deploy-staging.outputs.webapp-url }}" || echo "000")
            echo "Request $i: HTTP $response"
            
            if [ "$response" != "200" ] && [ "$response" != "503" ]; then
              echo "âš ï¸ Unexpected response during chaos"
            fi
            
            sleep 5
          done
          
          echo "âœ… Chaos validation complete"

  deploy-production:
    name: ðŸš€ Deploy to Production
    needs: [load-test]
    if: github.ref == 'refs/heads/main' && success()
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net
    
    steps:
      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ”„ Swap Staging to Production
        run: |
          az webapp deployment slot swap \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --slot staging \
            --target-slot production

      - name: ðŸ¥ Production Health Check
        run: |
          echo "Waiting for slot swap to complete..."
          sleep 60
          
          response=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health" || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "âœ… Production health check passed!"
          else
            echo "âŒ Production health check failed with status: $response"
            echo "ðŸ”„ Initiating rollback..."
            
            az webapp deployment slot swap \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --slot staging \
              --target-slot production
            
            exit 1
          fi

  notify:
    name: ðŸ“¢ Notify Results
    needs: [build, deploy-staging, load-test, deploy-production]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸŽ¯ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Staging | ${{ needs.deploy-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Load Test | ${{ needs.load-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Production | ${{ needs.deploy-production.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Azure Portal](https://portal.azure.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Application Insights](https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/microsoft.insights%2Fcomponents)" >> $GITHUB_STEP_SUMMARY
